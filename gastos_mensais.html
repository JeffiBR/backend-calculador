<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos e Faturas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Adicionar Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #5d78ff;
            --secondary-color: #8a9bff;
            --accent-color: #ff6b8b;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --light-color: #f8f9ff;
            --dark-color: #2d3748;
            --gray-light: #f1f3f9;
            --gray-medium: #e2e8f0;
            --text-light: #718096;
            --text-dark: #2d3748;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7ff 0%, #e6eeff 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 0 0 var(--radius) var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            padding: 10px 15px;
            border-radius: 8px;
            color: var(--text-dark);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .mobile-nav {
            display: none;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            padding: 15px;
        }
        
        .mobile-nav.active {
            display: block;
        }
        
        .mobile-nav-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-nav-link {
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--text-dark);
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-nav-link:hover, .mobile-nav-link.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .form-container {
            padding: 20px;
        }
        
        .form-section {
            background-color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        /* Dashboard Section */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 4px solid;
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card:nth-child(1) {
            border-top-color: #ff6b8b;
        }
        
        .dashboard-card:nth-child(2) {
            border-top-color: #5d78ff;
        }
        
        .dashboard-card:nth-child(3) {
            border-top-color: #4caf50;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .dashboard-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dashboard-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .dashboard-details {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .dashboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .dashboard-item:last-child {
            border-bottom: none;
        }
        
        .card-high {
            background: linear-gradient(135deg, #ffeaea 0%, #ffcccc 100%);
        }
        
        .card-medium {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }
        
        .card-low {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        /* Menu de Parcelas por Mês */
        .meses-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .mes-card {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mes-card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .mes-card.active {
            border-left-color: var(--accent-color);
            background-color: var(--light-color);
        }
        
        .mes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .mes-titulo {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .mes-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .mes-detalhes {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .mes-card.active .mes-detalhes {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        
        .cartao-fatura {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.85rem;
        }
        
        .cartao-fatura:last-child {
            border-bottom: none;
        }
        
        .cartao-fatura-nome {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cartao-fatura-valor {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .cartao-fatura-pago {
            color: var(--success-color);
        }
        
        .cartao-fatura-pendente {
            color: var(--error-color);
        }
        
        /* Botão Fixo de Pagamento do Mês */
        .mes-pagamento-fixo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--success-color) 0%, #3d8b40 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(93, 120, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            transition: all 0.3s;
        }
        
        .mes-pagamento-fixo:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(93, 120, 255, 0.7);
        }
        
        .mes-pagamento-fixo.hidden {
            display: none;
        }
        
        .mes-pagamento-fixo i {
            font-size: 1.2rem;
        }
        
        /* Botão para ver detalhes completos */
        .ver-detalhes-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
            border: 1px solid var(--primary-color);
        }
        
        .ver-detalhes-btn:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-dark);
            font-size: 0.9rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--gray-medium);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: var(--light-color);
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(93, 120, 255, 0.2);
            background-color: white;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(93, 120, 255, 0.3);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68a00;
        }
        
        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* Tabela de Gastos */
        .tabela-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        
        .tabela-gastos {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .tabela-gastos th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .tabela-gastos td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.85rem;
        }
        
        .tabela-gastos tr:hover {
            background-color: var(--light-color);
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-pago {
            background-color: #d4edda;
            color: #155724;
        }
        
        .acoes-cell {
            display: flex;
            gap: 8px;
        }
        
        .btn-acao {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .btn-pagar {
            background-color: #d4edda;
            color: #155724;
        }
        
        .btn-pagar:hover {
            background-color: #155724;
            color: white;
        }
        
        .btn-editar {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .btn-editar:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-excluir {
            background-color: #ffeaea;
            color: var(--error-color);
        }
        
        .btn-excluir:hover {
            background-color: var(--error-color);
            color: white;
        }
        
        /* Faturas por Cartão */
        .cartoes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .cartao-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            position: relative;
        }
        
        .cartao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
        }
        
        .cartao-nome {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cartao-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .cartao-detalhes {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        .cartao-detalhes-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .cartao-detalhes-item strong {
            color: var(--text-dark);
        }
        
        .cartao-resumo {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--gray-medium);
        }
        
        .resumo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .resumo-titulo {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .resumo-valor {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .resumo-aberto {
            color: var(--error-color);
        }
        
        .resumo-pago {
            color: var(--success-color);
        }
        
        .resumo-total {
            color: var(--primary-color);
        }
        
        .parcela-info {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            display: block;
        }
        
        /* Faturas Pendentes */
        .faturas-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .fatura-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--warning-color);
        }
        
        .fatura-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .fatura-titulo {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fatura-valor {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--error-color);
        }
        
        .fatura-detalhes {
            margin-bottom: 15px;
        }
        
        .fatura-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fatura-item:last-child {
            border-bottom: none;
        }
        
        /* Alertas */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .alert-error {
            background-color: #fff5f5;
            color: var(--error-color);
            border: 1px solid #fed7d7;
        }
        
        .alert-success {
            background-color: #f0fff4;
            color: var(--success-color);
            border: 1px solid #c6f6d5;
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .valor-real {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .data-formatada {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .info-badge {
            background-color: var(--light-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        
        /* Estilos para detalhes do cartão */
        .cartao-detalhes-expansivel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .cartao-card.expanded .cartao-detalhes-expansivel {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        
        .compras-lista {
            margin-top: 15px;
            border-top: 1px dashed var(--gray-medium);
            padding-top: 15px;
        }
        
        .compra-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
            background-color: var(--light-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .compra-info {
            flex: 1;
        }
        
        .compra-nome {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .compra-detalhes {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .compra-acoes {
            display: flex;
            gap: 8px;
        }
        
        .compra-valor {
            font-weight: 700;
            color: var(--primary-color);
            margin-left: 15px;
            min-width: 120px;
            text-align: right;
        }
        
        .parcela-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .parcela-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .parcela-paga {
            background-color: #d4edda;
            color: #155724;
        }
        
        .cartao-expand-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .cartao-expand-btn:hover {
            background-color: var(--light-color);
        }
        
        /* Campo de dinheiro com máscara */
        .money-input {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .money-input::placeholder {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: normal;
            color: #a0aec0;
        }
        
        /* Modal de Detalhes do Mês */
        .mes-detalhes-modal {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .mes-detalhes-modal::-webkit-scrollbar {
            width: 8px;
        }
        
        .mes-detalhes-modal::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 4px;
        }
        
        .mes-detalhes-modal::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .mes-detalhes-modal::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        .cartao-detalhes-completo {
            background: var(--light-color);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .cartao-detalhes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-medium);
        }
        
        .cartao-detalhes-nome {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cartao-detalhes-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .compras-lista-completa {
            margin-top: 10px;
        }
        
        .compra-item-completo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
            background-color: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .compra-info-completo {
            flex: 1;
        }
        
        .compra-nome-completo {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .compra-detalhes-completo {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .compra-valor-completo {
            font-weight: 700;
            color: var(--primary-color);
            margin-left: 15px;
            min-width: 100px;
            text-align: right;
        }
        
        .resumo-total-mes {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--primary-color);
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-container {
                padding: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .cartoes-container, .faturas-container, .dashboard-container, .meses-container {
                grid-template-columns: 1fr;
            }
            
            .cartao-card, .fatura-card, .dashboard-card, .mes-card {
                padding: 15px;
            }
            
            .tabela-gastos th,
            .tabela-gastos td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .mes-pagamento-fixo {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>
            <i class="fas fa-money-bill-wave"></i>
            Controle de Gastos e Faturas
        </h1>
        
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="calculator.html" class="nav-link">
                <i class="fas fa-calculator"></i>
                Calculadora
            </a>
            <a href="gastos_mensais.html" class="nav-link active">
                <i class="fas fa-credit-card"></i>
                Gastos Mensais
            </a>
        </div>
        
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobile-nav">
        <div class="mobile-nav-links">
            <a href="dashboard.html" class="mobile-nav-link">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="calculator.html" class="mobile-nav-link">
                <i class="fas fa-calculator"></i>
                Calculadora
            </a>
            <a href="gastos_mensais.html" class="mobile-nav-link active">
                <i class="fas fa-credit-card"></i>
                Gastos Mensais
            </a>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <div class="form-container">
            <div id="alert" class="alert"></div>
            
            <!-- Dashboard de Cartões com Maiores Faturas -->
            <div class="form-section" id="dashboardSection">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    <h2>Dashboard - Cartões com Maiores Faturas</h2>
                </div>
                <div id="dashboardContainer" class="dashboard-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando dashboard...
                    </div>
                </div>
            </div>
            
            <!-- Menu de Parcelas por Mês -->
            <div class="form-section" id="mesesSection">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    <h2>Parcelas por Mês</h2>
                </div>
                <div id="mesesContainer" class="meses-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando parcelas por mês...
                    </div>
                </div>
            </div>
            
            <!-- Faturas Pendentes -->
            <div class="form-section" id="faturasSection">
                <div class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    <h2>Faturas Pendentes</h2>
                </div>
                <div id="faturasContainer" class="faturas-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando faturas...
                    </div>
                </div>
            </div>
            
            <!-- Formulário Simples -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    <h2>Adicionar Nova Compra</h2>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="nomeProduto">
                            <i class="fas fa-tag"></i>
                            Produto/Serviço
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-pen input-icon"></i>
                            <input type="text" id="nomeProduto" placeholder="Ex: Supermercado">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="localCompra">
                            <i class="fas fa-store"></i>
                            Local
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-map-marker-alt input-icon"></i>
                            <input type="text" id="localCompra" placeholder="Ex: Supermercado X">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="valorTotal">
                            <i class="fas fa-dollar-sign"></i>
                            Valor Total (R$)
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-money-bill-wave input-icon"></i>
                            <input type="text" id="valorTotal" placeholder="0,00" class="money-input" lang="pt-BR">
                        </div>
                    </div>
                </div>
                
                <div class="grid-4">
                    <div class="form-group">
                        <label for="dataCompra">
                            <i class="fas fa-calendar"></i>
                            Data da Compra
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar input-icon"></i>
                            <input type="date" id="dataCompra">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cartao">
                            <i class="fas fa-credit-card"></i>
                            Cartão
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-credit-card input-icon"></i>
                            <select id="cartao">
                                <option value="">Selecione...</option>
                                <option value="Banco Pan">Banco Pan</option>
                                <option value="Atacadão">Atacadão</option>
                                <option value="Nubank">Nubank</option>
                                <option value="Santander">Santander</option>
                                <option value="Riachuello">Riachuello</option>
                                <option value="Le Bescuit">Le Bescuit</option>
                                <option value="C&A">C&A</option>
                                <option value="Renner">Renner</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Cartão Mais">Cartão Mais</option>
                                <option value="Mais">Mais</option>
                                <option value="Brasil Card">Brasil Card</option>
                                <option value="Azul Atacarejo">Azul Atacarejo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="parcelas">
                            <i class="fas fa-calendar-alt"></i>
                            Parcelas
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-sort-numeric-up input-icon"></i>
                            <select id="parcelas">
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                                <option value="5">5x</option>
                                <option value="6">6x</option>
                                <option value="7">7x</option>
                                <option value="8">8x</option>
                                <option value="9">9x</option>
                                <option value="10">10x</option>
                                <option value="11">11x</option>
                                <option value="12">12x</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="diaFatura">
                            <i class="fas fa-calendar-check"></i>
                            Dia da Fatura (Vencimento)
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-check input-icon"></i>
                            <input type="number" id="diaFatura" min="1" max="31" value="10">
                        </div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button type="button" id="adicionarCompra" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Adicionar Compra
                    </button>
                    <button type="button" id="limparForm" class="btn btn-warning">
                        <i class="fas fa-broom"></i>
                        Limpar
                    </button>
                </div>
            </div>
            
            <!-- Resumo por Cartão -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    <h2>Resumo por Cartão</h2>
                </div>
                <div id="cartoesContainer" class="cartoes-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando resumo...
                    </div>
                </div>
            </div>
            
            <!-- Todas as Compras -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    <h2>Todas as Compras</h2>
                </div>
                
                <div class="tabela-container">
                    <table class="tabela-gastos" id="tabelaGastos">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Local</th>
                                <th>Valor Total</th>
                                <th>Data Compra</th>
                                <th>Cartão</th>
                                <th>Parcelas</th>
                                <th>Valor Parcela</th>
                                <th>Próxima Fatura</th>
                                <th>Valor em Aberto</th>
                                <th>Valor Pago</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaGastosBody">
                            <tr id="loadingRow">
                                <td colspan="12" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> Carregando compras...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Fixo de Pagamento do Mês -->
    <button id="botaoPagamentoMes" class="mes-pagamento-fixo hidden">
        <i class="fas fa-money-bill-wave"></i>
        <span id="textoBotaoPagamento">Pagar Mês Atual</span>
    </button>

    <!-- Modal para Detalhes do Mês -->
    <div id="modalDetalhesMes" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="modalMesTitulo">Detalhes do Mês</span>
                </h3>
                <button class="modal-close" onclick="fecharModalDetalhesMes()">&times;</button>
            </div>
            <div id="modalDetalhesMesContent" class="mes-detalhes-modal">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="pagarMesModal()" class="btn btn-success" style="width: 100%;">
                    <i class="fas fa-check"></i> Pagar Todas as Parcelas deste Mês
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Pagar Fatura -->
    <div id="modalPagarFatura" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-money-check-alt"></i>
                    Pagar Fatura
                </h3>
                <button class="modal-close" onclick="fecharModalPagar()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Conteúdo do modal será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal para Editar Compra -->
    <div id="modalEditarCompra" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Editar Compra
                </h3>
                <button class="modal-close" onclick="fecharModalEditar()">&times;</button>
            </div>
            <div id="modalEditarContent">
                <!-- Conteúdo do modal será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal para Seleção de Mês de Pagamento -->
    <div id="modalSelecaoMes" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Selecionar Mês para Pagamento
                </h3>
                <button class="modal-close" onclick="fecharModalSelecaoMes()">&times;</button>
            </div>
            <div id="modalSelecaoMesContent">
                <!-- Conteúdo será preenchido com a lista de meses -->
            </div>
        </div>
    </div>

    <script>
    // Configuração
    const BACKEND_URL = 'https://backend-calculador.onrender.com';
    const GASTOS_ENDPOINT = `${BACKEND_URL}/api/gastos`;
    
    // Configuração do Supabase
    const SUPABASE_URL = 'https://pcbtgvdcihowmtmqzhns.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjYnRndmRjaWhvd210bXF6aG5zIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzIyODk1OSwiZXhwIjoyMDc4ODA0OTU5fQ.2F5YFviXUv5LeQmNKvPgiVAHmeioJ_3ro9K8enZxVsM';
    
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Todos os cartões
    const todosCartoes = [
        "Banco Pan", "Atacadão", "Nubank", "Santander", "Riachuello", 
        "Le Bescuit", "C&A", "Renner", "Mercado Livre", 
        "Cartão Mais", "Mais", "Brasil Card", "Azul Atacarejo"
    ];

    // Variável para armazenar os meses com parcelas
    let mesesComParcelas = [];
    let mesAtualSelecionado = null;
    let mesDetalhesAberto = null;

    // Menu mobile
    document.getElementById('menu-toggle').addEventListener('click', function() {
        document.getElementById('mobile-nav').classList.toggle('active');
    });

    // Configurar data atual
    document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];

    // =============================================
    // FUNÇÕES AUXILIARES PARA FORMATAÇÃO DE MOEDA
    // =============================================

    function formatarParaMoeda(valor) {
        // Se já for uma string formatada, retorna ela mesma
        if (typeof valor === 'string' && valor.includes(',')) {
            return valor;
        }
        
        // Converte para número
        const numero = parseFloat(valor);
        
        if (isNaN(numero)) {
            return '0,00';
        }
        
        // Formata para o padrão brasileiro
        return numero.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function converterMoedaParaNumero(valorString) {
        if (!valorString || valorString.trim() === '') return 0;
        
        // Remove o R$ e espaços
        let valor = valorString.toString().trim();
        
        // Remove todos os pontos (separadores de milhar)
        valor = valor.replace(/\./g, '');
        
        // Substitui vírgula por ponto para conversão
        valor = valor.replace(',', '.');
        
        // Remove qualquer caractere que não seja número ou ponto
        valor = valor.replace(/[^\d.-]/g, '');
        
        // Converte para número
        const numero = parseFloat(valor);
        
        return isNaN(numero) ? 0 : numero;
    }

    function formatarNumeroParaInput(valor) {
        const numero = parseFloat(valor);
        if (isNaN(numero)) return '0,00';
        
        // Formata para string com 2 casas decimais, substituindo ponto por vírgula
        return numero.toFixed(2).replace('.', ',');
    }

    function aplicarMascaraMoeda(input) {
        input.addEventListener('input', function(e) {
            let valor = e.target.value;
            
            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');
            
            // Se estiver vazio, define como 0
            if (valor === '') {
                e.target.value = '0,00';
                return;
            }
            
            // Converte para número inteiro (centavos)
            const valorInteiro = parseInt(valor, 10);
            
            // Calcula reais e centavos
            const reais = Math.floor(valorInteiro / 100);
            const centavos = valorInteiro % 100;
            
            // Formata com separadores de milhar
            let valorFormatado = reais.toLocaleString('pt-BR');
            
            // Adiciona os centavos
            valorFormatado += ',' + centavos.toString().padStart(2, '0');
            
            e.target.value = valorFormatado;
        });
        
        input.addEventListener('blur', function(e) {
            let valor = e.target.value;
            
            // Garante que sempre tenha 2 casas decimais
            if (valor && !valor.includes(',')) {
                valor = valor + ',00';
            } else if (valor.includes(',')) {
                const partes = valor.split(',');
                if (partes.length === 2) {
                    // Garante 2 dígitos após a vírgula
                    partes[1] = partes[1].padEnd(2, '0').substring(0, 2);
                    valor = partes[0] + ',' + partes[1];
                }
            }
            
            e.target.value = valor;
        });
        
        input.addEventListener('focus', function(e) {
            let valor = e.target.value;
            if (valor === '0,00') {
                e.target.value = '';
            }
        });
    }

    function garantirNumero(valor) {
        if (valor === null || valor === undefined || valor === '' || isNaN(valor)) {
            return 0;
        }
        const num = parseFloat(valor);
        return isNaN(num) ? 0 : num;
    }

    function mostrarAlerta(mensagem, tipo) {
        const alert = document.getElementById('alert');
        alert.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${mensagem}`;
        alert.className = `alert alert-${tipo}`;
        alert.style.display = 'flex';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    function formatarMoeda(valor) {
        const num = garantirNumero(valor);
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }

    function formatarData(data) {
        try {
            if (!data) return 'N/A';
            const dataObj = new Date(data);
            if (isNaN(dataObj.getTime())) {
                return 'Data inválida';
            }
            return dataObj.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            console.error('Erro ao formatar data:', e);
            return 'N/A';
        }
    }

    function formatarMesAno(mes, ano) {
        const meses = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        return `${meses[mes - 1]} / ${ano}`;
    }

    // =============================================
    // FUNÇÕES DE CÁLCULO DO DIA DA FATURA
    // =============================================

    // Função para calcular o mês da fatura baseado no dia de vencimento
    function calcularMesFatura(dataCompra, diaFatura) {
        const data = new Date(dataCompra);
        const diaCompra = data.getDate();
        const mesCompra = data.getMonth() + 1;
        const anoCompra = data.getFullYear();
        
        // Se a compra foi feita após o dia da fatura (com margem de 5 dias para trás)
        // ou se está muito próximo do vencimento (5 dias ou menos), vai para o próximo mês
        if (diaCompra > diaFatura - 5) {
            // Vai para o próximo mês
            let mesFatura = mesCompra + 1;
            let anoFatura = anoCompra;
            
            if (mesFatura > 12) {
                mesFatura = 1;
                anoFatura += 1;
            }
            
            return { mes: mesFatura, ano: anoFatura };
        } else {
            // Fica no mês atual
            return { mes: mesCompra, ano: anoCompra };
        }
    }

    // Calcular próxima fatura considerando o dia de vencimento
    function calcularProximaFatura(compra) {
        if (!compra || compra.status === 'pago') return null;
        
        const parcelasPagas = compra.parcelas_pagas || 0;
        const numParcelas = compra.num_parcelas || 1;
        
        if (parcelasPagas >= numParcelas) return null;
        
        const dataCompra = new Date(compra.data_compra);
        const diaFatura = compra.dia_fatura || 10;
        
        // Calcular mês da primeira fatura
        const primeiraFatura = calcularMesFatura(compra.data_compra, diaFatura);
        
        // Mês da próxima fatura
        let mesFatura = primeiraFatura.mes + parcelasPagas;
        let anoFatura = primeiraFatura.ano;
        
        // Ajustar se passar de dezembro
        while (mesFatura > 12) {
            mesFatura -= 12;
            anoFatura += 1;
        }
        
        const valorParcela = compra.valor_parcela || (compra.valor_total / numParcelas);
        
        return {
            mes: mesFatura,
            ano: anoFatura,
            valor: valorParcela,
            diaFatura: diaFatura
        };
    }

    // Calcular a fatura para uma parcela específica
    function calcularFaturaParcela(compra, numeroParcela) {
        const dataCompra = new Date(compra.data_compra);
        const diaFatura = compra.dia_fatura || 10;
        
        // Calcular mês da primeira fatura
        const primeiraFatura = calcularMesFatura(dataCompra, diaFatura);
        
        // Mês da fatura desta parcela (subtrair 1 porque a primeira parcela é 1)
        let mesFatura = primeiraFatura.mes + (numeroParcela - 1);
        let anoFatura = primeiraFatura.ano;
        
        // Ajustar se passar de dezembro
        while (mesFatura > 12) {
            mesFatura -= 12;
            anoFatura += 1;
        }
        
        return {
            mes: mesFatura,
            ano: anoFatura,
            diaFatura: diaFatura
        };
    }

    // Aplicar máscara de moeda ao campo valorTotal
    document.addEventListener('DOMContentLoaded', function() {
        const valorTotalInput = document.getElementById('valorTotal');
        if (valorTotalInput) {
            aplicarMascaraMoeda(valorTotalInput);
        }
    });

    // =============================================
    // FUNÇÕES DE LEITURA DO SUPABASE
    // =============================================

    async function carregarGastosDoSupabase() {
        try {
            const tbody = document.getElementById('tabelaGastosBody');
            
            // Mostrar loading
            tbody.innerHTML = `
                <tr id="loadingRow">
                    <td colspan="12" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando compras...
                    </td>
                </tr>
            `;
            
            // Ler dados diretamente do Supabase
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*')
                .order('data_compra', { ascending: false });
            
            if (error) {
                throw error;
            }
            
            atualizarTabela(compras);
            return compras;
            
        } catch (error) {
            console.error('Erro ao carregar compras do Supabase:', error);
            const tbody = document.getElementById('tabelaGastosBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" style="text-align: center; color: var(--error-color); padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar compras: ${error.message}
                    </td>
                </tr>
            `;
            return [];
        }
    }

    async function carregarFaturasPendentesDoSupabase() {
        try {
            const container = document.getElementById('faturasContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando faturas...</div>';
            
            // Carregar todas as compras pendentes
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*')
                .eq('status', 'pendente')
                .order('data_compra', { ascending: true });
            
            if (error) {
                throw error;
            }
            
            // Agrupar faturas por cartão e mês/ano
            const faturasAgrupadas = agruparFaturasPendentes(compras);
            atualizarFaturasPendentes(faturasAgrupadas);
            
        } catch (error) {
            console.error('Erro ao carregar faturas pendentes:', error);
            const container = document.getElementById('faturasContainer');
            container.innerHTML = `
                <div class="fatura-card" style="grid-column: 1 / -1;">
                    <div class="fatura-header">
                        <div class="fatura-titulo">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao carregar faturas
                        </div>
                    </div>
                    <div class="fatura-detalhes">
                        <p>Erro: ${error.message}</p>
                        <button onclick="carregarFaturasPendentesDoSupabase()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-top: 10px;
                        ">
                            <i class="fas fa-redo"></i> Tentar novamente
                        </button>
                    </div>
                </div>
            `;
        }
    }

    function agruparFaturasPendentes(compras) {
        const faturas = {};
        
        compras.forEach(compra => {
            if (compra.status !== 'pendente') return;
            
            // Calcular próximas faturas para cada parcela pendente
            const parcelasPagas = compra.parcelas_pagas || 0;
            const numParcelas = compra.num_parcelas || 1;
            
            for (let i = parcelasPagas; i < numParcelas; i++) {
                const parcelaNumero = i + 1;
                const fatura = calcularFaturaParcela(compra, parcelaNumero);
                const chave = `${compra.cartao}-${fatura.mes}-${fatura.ano}`;
                
                if (!faturas[chave]) {
                    faturas[chave] = {
                        cartao: compra.cartao,
                        mes: fatura.mes,
                        ano: fatura.ano,
                        valor_total: 0,
                        compras: []
                    };
                }
                
                const valorParcela = compra.valor_parcela || (compra.valor_total / numParcelas);
                faturas[chave].valor_total += valorParcela;
                faturas[chave].compras.push({
                    nome_produto: compra.nome_produto,
                    valor_parcela: valorParcela
                });
            }
        });
        
        return Object.values(faturas);
    }

    async function carregarResumoCartoesDoSupabase() {
        try {
            const container = document.getElementById('cartoesContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando resumo...</div>';
            
            // Carregar todas as compras
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*');
            
            if (error) {
                throw error;
            }
            
            // Calcular resumo
            const resumo = calcularResumoCartoes(compras);
            
            // Carregar compras detalhadas para mostrar no resumo expandido
            const comprasPorCartao = await carregarComprasParaResumo();
            
            atualizarResumoCartoes(resumo, comprasPorCartao);
            
        } catch (error) {
            console.error('Erro ao carregar resumo:', error);
            const container = document.getElementById('cartoesContainer');
            container.innerHTML = `
                <div class="cartao-card" style="grid-column: 1 / -1;">
                    <div class="cartao-header">
                        <div class="cartao-nome">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao carregar resumo
                        </div>
                    </div>
                    <div class="cartao-detalhes">
                        <p>Erro: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }

    function calcularResumoCartoes(compras) {
        const resumo = {};
        
        todosCartoes.forEach(cartao => {
            resumo[cartao] = {
                total: 0,
                compras: 0,
                parcelas_pendentes: 0,
                valor_pendente: 0,
                valor_pago: 0,
                valor_aberto: 0,
                parcelas_pagas_total: 0,
                parcelas_total: 0
            };
        });
        
        compras.forEach(compra => {
            const cartao = compra.cartao;
            if (!resumo[cartao]) return;
            
            const valorTotal = garantirNumero(compra.valor_total);
            const numParcelas = garantirNumero(compra.num_parcelas);
            const parcelasPagas = garantirNumero(compra.parcelas_pagas) || 
                (compra.status === 'pago' ? numParcelas : 0);
            const valorParcela = garantirNumero(compra.valor_parcela) || 
                (valorTotal / Math.max(1, numParcelas));
            
            resumo[cartao].total += valorTotal;
            resumo[cartao].compras += 1;
            resumo[cartao].parcelas_pagas_total += parcelasPagas;
            resumo[cartao].parcelas_total += numParcelas;
            resumo[cartao].valor_pago += valorParcela * parcelasPagas;
            resumo[cartao].valor_pendente += valorParcela * (numParcelas - parcelasPagas);
            resumo[cartao].parcelas_pendentes += (numParcelas - parcelasPagas);
        });
        
        todosCartoes.forEach(cartao => {
            resumo[cartao].valor_aberto = resumo[cartao].valor_pendente;
        });
        
        return resumo;
    }

    // Função para carregar compras agrupadas por cartão
    async function carregarComprasParaResumo() {
        try {
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*')
                .order('data_compra', { ascending: false });
            
            if (error) {
                throw error;
            }
            
            // Agrupar compras por cartão
            const comprasPorCartao = {};
            compras.forEach(compra => {
                if (!comprasPorCartao[compra.cartao]) {
                    comprasPorCartao[compra.cartao] = [];
                }
                comprasPorCartao[compra.cartao].push(compra);
            });
            
            return comprasPorCartao;
        } catch (error) {
            console.error('Erro ao carregar compras para resumo:', error);
            return {};
        }
    }

    // =============================================
    // NOVAS FUNÇÕES PARA DASHBOARD E PARCELAS POR MÊS
    // =============================================

    async function carregarDashboard() {
        try {
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dashboard...</div>';
            
            // Carregar todas as compras
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*');
            
            if (error) {
                throw error;
            }
            
            // Calcular cartões com maiores faturas em aberto
            const cartoesEmAberto = calcularCartoesComMaioresFaturas(compras);
            atualizarDashboard(cartoesEmAberto);
            
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = `
                <div class="dashboard-card" style="grid-column: 1 / -1;">
                    <div class="dashboard-header">
                        <div class="dashboard-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao carregar dashboard
                        </div>
                    </div>
                    <div class="dashboard-details">
                        <p>Erro: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }

    function calcularCartoesComMaioresFaturas(compras) {
        const cartoes = {};
        
        // Inicializar todos os cartões
        todosCartoes.forEach(cartao => {
            cartoes[cartao] = {
                valor_aberto: 0,
                total_compras: 0,
                parcelas_pendentes: 0,
                faturas_pendentes: 0
            };
        });
        
        // Calcular valores em aberto por cartão
        compras.forEach(compra => {
            if (compra.status !== 'pendente') return;
            
            const cartao = compra.cartao;
            const valorTotal = garantirNumero(compra.valor_total);
            const numParcelas = garantirNumero(compra.num_parcelas);
            const parcelasPagas = garantirNumero(compra.parcelas_pagas) || 0;
            const valorParcela = garantirNumero(compra.valor_parcela) || (valorTotal / Math.max(1, numParcelas));
            const valorEmAberto = valorParcela * (numParcelas - parcelasPagas);
            
            if (cartoes[cartao]) {
                cartoes[cartao].valor_aberto += valorEmAberto;
                cartoes[cartao].total_compras += 1;
                cartoes[cartao].parcelas_pendentes += (numParcelas - parcelasPagas);
                cartoes[cartao].faturas_pendentes += 1;
            }
        });
        
        // Filtrar cartões com valor em aberto > 0 e ordenar do maior para o menor
        const cartoesComValor = Object.entries(cartoes)
            .filter(([cartao, dados]) => dados.valor_aberto > 0)
            .sort((a, b) => b[1].valor_aberto - a[1].valor_aberto);
        
        return cartoesComValor.slice(0, 5); // Top 5 cartões
    }

    function atualizarDashboard(cartoes) {
        const container = document.getElementById('dashboardContainer');
        
        if (!cartoes || cartoes.length === 0) {
            container.innerHTML = `
                <div class="dashboard-card" style="grid-column: 1 / -1;">
                    <div class="dashboard-header">
                        <div class="dashboard-title">
                            <i class="fas fa-check-circle"></i>
                            Nenhuma fatura em aberto
                        </div>
                    </div>
                    <div class="dashboard-details">
                        <p>Todos os cartões estão com as faturas em dia!</p>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        // Adicionar cartão com total geral
        const totalGeral = cartoes.reduce((total, [cartao, dados]) => total + dados.valor_aberto, 0);
        
        const cardTotal = document.createElement('div');
        cardTotal.className = 'dashboard-card card-high';
        cardTotal.innerHTML = `
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <i class="fas fa-chart-line"></i>
                    Total em Aberto
                </div>
            </div>
            <div class="dashboard-value">${formatarMoeda(totalGeral)}</div>
            <div class="dashboard-details">
                <div class="dashboard-item">
                    <span>Cartões com faturas:</span>
                    <span>${cartoes.length}</span>
                </div>
                <div class="dashboard-item">
                    <span>Faturas pendentes:</span>
                    <span>${cartoes.reduce((total, [cartao, dados]) => total + dados.faturas_pendentes, 0)}</span>
                </div>
            </div>
        `;
        container.appendChild(cardTotal);
        
        // Adicionar cartões individuais
        cartoes.forEach(([cartao, dados], index) => {
            let cardClass = 'card-high';
            if (index === 1) cardClass = 'card-medium';
            if (index >= 2) cardClass = 'card-low';
            
            const card = document.createElement('div');
            card.className = `dashboard-card ${cardClass}`;
            card.innerHTML = `
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <i class="fas fa-credit-card"></i>
                        ${cartao}
                    </div>
                    <span class="info-badge">${index + 1}º</span>
                </div>
                <div class="dashboard-value">${formatarMoeda(dados.valor_aberto)}</div>
                <div class="dashboard-details">
                    <div class="dashboard-item">
                        <span>Compras:</span>
                        <span>${dados.total_compras}</span>
                    </div>
                    <div class="dashboard-item">
                        <span>Parcelas pendentes:</span>
                        <span>${dados.parcelas_pendentes}</span>
                    </div>
                    <div class="dashboard-item">
                        <span>Faturas pendentes:</span>
                        <span>${dados.faturas_pendentes}</span>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function carregarParcelasPorMes() {
        try {
            const container = document.getElementById('mesesContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando parcelas por mês...</div>';
            
            // Carregar todas as compras
            const { data: compras, error } = await supabase
                .from('gastos_mensais')
                .select('*')
                .order('data_compra', { ascending: true });
            
            if (error) {
                throw error;
            }
            
            // Agrupar parcelas por mês
            const parcelasPorMes = agruparParcelasPorMes(compras);
            atualizarParcelasPorMes(parcelasPorMes);
            
        } catch (error) {
            console.error('Erro ao carregar parcelas por mês:', error);
            const container = document.getElementById('mesesContainer');
            container.innerHTML = `
                <div class="mes-card" style="grid-column: 1 / -1;">
                    <div class="mes-header">
                        <div class="mes-titulo">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao carregar parcelas
                        </div>
                    </div>
                    <div class="mes-detalhes">
                        <p>Erro: ${error.message}</p>
                    </div>
                </div>
            `;
        }
    }

    function agruparParcelasPorMes(compras) {
        const meses = {};
        const hoje = new Date();
        const mesAtual = hoje.getMonth() + 1;
        const anoAtual = hoje.getFullYear();
        
        // Inicializar próximos 12 meses
        for (let i = 0; i < 12; i++) {
            let mes = mesAtual + i;
            let ano = anoAtual;
            
            while (mes > 12) {
                mes -= 12;
                ano += 1;
            }
            
            const chave = `${mes}-${ano}`;
            meses[chave] = {
                mes,
                ano,
                total: 0,
                cartoes: {},
                compras: 0,
                compras_detalhes: [] // Adicionando para armazenar detalhes das compras
            };
        }
        
        // Processar cada compra
        compras.forEach(compra => {
            const numParcelas = compra.num_parcelas || 1;
            const parcelasPagas = compra.parcelas_pagas || 0;
            const valorParcela = compra.valor_parcela || (compra.valor_total / numParcelas);
            
            // Para cada parcela não paga
            for (let i = parcelasPagas; i < numParcelas; i++) {
                const parcelaNumero = i + 1;
                const fatura = calcularFaturaParcela(compra, parcelaNumero);
                const chave = `${fatura.mes}-${fatura.ano}`;
                
                if (meses[chave]) {
                    meses[chave].total += valorParcela;
                    meses[chave].compras += 1;
                    
                    // Armazenar detalhes da compra
                    meses[chave].compras_detalhes.push({
                        nome_produto: compra.nome_produto,
                        local_compra: compra.local_compra,
                        valor_total: compra.valor_total,
                        valor_parcela: valorParcela,
                        cartao: compra.cartao,
                        status: compra.status,
                        parcela_numero: parcelaNumero,
                        num_parcelas: numParcelas,
                        parcelas_pagas: parcelasPagas,
                        data_compra: compra.data_compra,
                        id: compra.id
                    });
                    
                    // Agrupar por cartão
                    if (!meses[chave].cartoes[compra.cartao]) {
                        meses[chave].cartoes[compra.cartao] = {
                            valor: 0,
                            compras: []
                        };
                    }
                    
                    meses[chave].cartoes[compra.cartao].valor += valorParcela;
                    meses[chave].cartoes[compra.cartao].compras.push({
                        nome: compra.nome_produto,
                        valor: valorParcela,
                        status: compra.status,
                        parcela_numero: parcelaNumero,
                        num_parcelas: numParcelas,
                        parcelas_pagas: parcelasPagas
                    });
                }
            }
        });
        
        return Object.values(meses).filter(mes => mes.total > 0);
    }

    function atualizarParcelasPorMes(meses) {
        const container = document.getElementById('mesesContainer');
        
        // Armazenar meses globalmente
        mesesComParcelas = meses;
        
        // Atualizar botão fixo
        atualizarBotaoFixoPagamento();
        
        if (!meses || meses.length === 0) {
            container.innerHTML = `
                <div class="mes-card" style="grid-column: 1 / -1;">
                    <div class="mes-header">
                        <div class="mes-titulo">
                            <i class="fas fa-calendar-check"></i>
                            Nenhuma parcela futura
                        </div>
                    </div>
                    <div class="mes-detalhes">
                        <p>Não há parcelas pendentes para os próximos meses.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        meses.forEach(mes => {
            const isMesAtual = mes.mes === new Date().getMonth() + 1 && mes.ano === new Date().getFullYear();
            
            const card = document.createElement('div');
            card.className = `mes-card ${isMesAtual ? 'active' : ''}`;
            card.innerHTML = `
                <div class="mes-header" onclick="toggleMesDetalhes(this)">
                    <div class="mes-titulo">
                        <i class="fas fa-calendar"></i>
                        ${formatarMesAno(mes.mes, mes.ano)}
                        ${isMesAtual ? '<span style="color: var(--accent-color); font-size: 0.8rem;">(ATUAL)</span>' : ''}
                    </div>
                    <div class="mes-total">${formatarMoeda(mes.total)}</div>
                </div>
                <div class="mes-detalhes">
                    <div style="margin-bottom: 10px; font-size: 0.9rem; color: var(--text-light);">
                        ${mes.compras} compra(s) • ${Object.keys(mes.cartoes).length} cartão(ões)
                    </div>
                    ${Object.entries(mes.cartoes).slice(0, 3).map(([cartao, dados]) => `
                        <div class="cartao-fatura">
                            <div class="cartao-fatura-nome">
                                <i class="fas fa-credit-card"></i>
                                ${cartao}
                            </div>
                            <div class="cartao-fatura-valor">
                                ${formatarMoeda(dados.valor)}
                            </div>
                        </div>
                        ${dados.compras.slice(0, 2).map(compra => `
                            <div class="cartao-fatura" style="padding-left: 20px; font-size: 0.8rem;">
                                <div class="cartao-fatura-nome">
                                    <i class="fas fa-shopping-cart"></i>
                                    ${compra.nome.substring(0, 30)}${compra.nome.length > 30 ? '...' : ''}
                                </div>
                                <div class="cartao-fatura-valor ${compra.status === 'pendente' ? 'cartao-fatura-pendente' : 'cartao-fatura-pago'}">
                                    ${formatarMoeda(compra.valor)}
                                </div>
                            </div>
                        `).join('')}
                    `).join('')}
                    
                    ${Object.keys(mes.cartoes).length > 3 || 
                      (Object.values(mes.cartoes).reduce((total, dados) => total + dados.compras.length, 0) > 6) ? `
                        <button class="ver-detalhes-btn" onclick="abrirModalDetalhesMes(${mes.mes}, ${mes.ano}, event)">
                            <i class="fas fa-external-link-alt"></i>
                            Ver todos os detalhes (${Object.keys(mes.cartoes).length} cartões)
                        </button>
                    ` : ''}
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="pagarFaturaMes(${mes.mes}, ${mes.ano})" class="btn btn-success" style="width: 100%;">
                            <i class="fas fa-check"></i> Pagar Todas (${formatarMoeda(mes.total)})
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleMesDetalhes(element) {
        const card = element.closest('.mes-card');
        card.classList.toggle('active');
    }

    // =============================================
    // FUNÇÕES PARA O MODAL DE DETALHES DO MÊS
    // =============================================

    function abrirModalDetalhesMes(mes, ano, event) {
        if (event) {
            event.stopPropagation();
        }
        
        const mesEncontrado = mesesComParcelas.find(m => m.mes === mes && m.ano === ano);
        
        if (!mesEncontrado) {
            mostrarAlerta('Mês não encontrado!', 'error');
            return;
        }
        
        mesDetalhesAberto = mesEncontrado;
        
        // Atualizar título do modal
        document.getElementById('modalMesTitulo').textContent = 
            `Detalhes de ${formatarMesAno(mes, ano)}`;
        
        // Construir conteúdo do modal
        const modalContent = document.getElementById('modalDetalhesMesContent');
        
        let html = `
            <div style="margin-bottom: 20px; padding: 15px; background: var(--light-color); border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: 600; color: var(--text-dark);">Resumo do Mês</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            ${mesEncontrado.compras} compra(s) • ${Object.keys(mesEncontrado.cartoes).length} cartão(ões)
                        </div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                        ${formatarMoeda(mesEncontrado.total)}
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar detalhes de cada cartão
        Object.entries(mesEncontrado.cartoes).forEach(([cartao, dados]) => {
            html += `
                <div class="cartao-detalhes-completo">
                    <div class="cartao-detalhes-header">
                        <div class="cartao-detalhes-nome">
                            <i class="fas fa-credit-card"></i>
                            ${cartao}
                        </div>
                        <div class="cartao-detalhes-total">
                            ${formatarMoeda(dados.valor)}
                        </div>
                    </div>
                    
                    <div class="compras-lista-completa">
                        ${dados.compras.map(compra => `
                            <div class="compra-item-completo">
                                <div class="compra-info-completo">
                                    <div class="compra-nome-completo">
                                        ${compra.nome}
                                    </div>
                                    <div class="compra-detalhes-completo">
                                        <span>
                                            <i class="fas fa-calendar"></i>
                                            Parcela ${compra.parcela_numero}/${compra.num_parcelas}
                                        </span>
                                        <span>
                                            <i class="fas fa-${compra.status === 'pendente' ? 'clock' : 'check'}"></i>
                                            ${compra.status === 'pendente' ? 'Pendente' : 'Pago'}
                                        </span>
                                        <span>
                                            <i class="fas fa-money-bill"></i>
                                            ${compra.parcelas_pagas}/${compra.num_parcelas} pagas
                                        </span>
                                    </div>
                                </div>
                                <div class="compra-valor-completo">
                                    ${formatarMoeda(compra.valor)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        // Adicionar lista completa de compras
        if (mesEncontrado.compras_detalhes && mesEncontrado.compras_detalhes.length > 0) {
            html += `
                <div style="margin-top: 20px; padding: 15px; background: var(--light-color); border-radius: var(--radius);">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-list"></i>
                        Todas as Compras do Mês (${mesEncontrado.compras_detalhes.length})
                    </h4>
                    
                    <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                        ${mesEncontrado.compras_detalhes.map(compra => `
                            <div style="
                                padding: 12px;
                                margin-bottom: 10px;
                                background: white;
                                border-radius: 8px;
                                border-left: 4px solid ${compra.status === 'pendente' ? 'var(--warning-color)' : 'var(--success-color)'};
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 5px;">
                                            ${compra.nome_produto}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 5px;">
                                            <span style="margin-right: 15px;">
                                                <i class="fas fa-store"></i> ${compra.local_compra || 'Sem local'}
                                            </span>
                                            <span style="margin-right: 15px;">
                                                <i class="fas fa-calendar"></i> ${formatarData(compra.data_compra)}
                                            </span>
                                            <span>
                                                <i class="fas fa-credit-card"></i> ${compra.cartao}
                                            </span>
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-light);">
                                            <span style="margin-right: 15px;">
                                                <i class="fas fa-money-bill-wave"></i> 
                                                Total: ${formatarMoeda(compra.valor_total)}
                                            </span>
                                            <span>
                                                <i class="fas fa-calendar-alt"></i> 
                                                Parcela: ${formatarMoeda(compra.valor_parcela)} (${compra.parcela_numero}/${compra.num_parcelas})
                                            </span>
                                        </div>
                                    </div>
                                    <div style="text-align: right; min-width: 120px;">
                                        <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 5px;">
                                            ${formatarMoeda(compra.valor_parcela)}
                                        </div>
                                        <span class="parcela-status ${compra.status === 'pendente' ? 'parcela-pendente' : 'parcela-paga'}" 
                                              style="font-size: 0.7rem;">
                                            ${compra.status === 'pendente' ? 'PENDENTE' : 'PAGO'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Adicionar total no final
        html += `
            <div class="resumo-total-mes">
                Total do Mês: ${formatarMoeda(mesEncontrado.total)}
            </div>
        `;
        
        modalContent.innerHTML = html;
        
        // Mostrar modal
        document.getElementById('modalDetalhesMes').style.display = 'flex';
    }

    function fecharModalDetalhesMes() {
        document.getElementById('modalDetalhesMes').style.display = 'none';
        mesDetalhesAberto = null;
    }

    function pagarMesModal() {
        if (mesDetalhesAberto) {
            fecharModalDetalhesMes();
            pagarFaturaMes(mesDetalhesAberto.mes, mesDetalhesAberto.ano);
        }
    }

    // =============================================
    // FUNÇÕES PARA O BOTÃO FIXO DE PAGAMENTO
    // =============================================

    function atualizarBotaoFixoPagamento() {
        const botao = document.getElementById('botaoPagamentoMes');
        const textoBotao = document.getElementById('textoBotaoPagamento');
        
        if (mesesComParcelas.length === 0) {
            botao.classList.add('hidden');
            return;
        }
        
        // Encontrar o mês atual
        const hoje = new Date();
        const mesAtual = hoje.getMonth() + 1;
        const anoAtual = hoje.getFullYear();
        
        const mesAtualEncontrado = mesesComParcelas.find(mes => 
            mes.mes === mesAtual && mes.ano === anoAtual
        );
        
        if (mesAtualEncontrado) {
            textoBotao.textContent = `Pagar Mês Atual (${formatarMoeda(mesAtualEncontrado.total)})`;
            mesAtualSelecionado = mesAtualEncontrado;
            botao.classList.remove('hidden');
        } else {
            // Se não houver mês atual, mostrar o primeiro mês disponível
            const primeiroMes = mesesComParcelas[0];
            textoBotao.textContent = `Pagar ${formatarMesAno(primeiroMes.mes, primeiroMes.ano)} (${formatarMoeda(primeiroMes.total)})`;
            mesAtualSelecionado = primeiroMes;
            botao.classList.remove('hidden');
        }
    }

    // Adicionar evento de clique ao botão fixo
    document.getElementById('botaoPagamentoMes').addEventListener('click', function() {
        if (mesAtualSelecionado) {
            abrirModalSelecaoMes();
        }
    });

    // Abrir modal de seleção de mês
    function abrirModalSelecaoMes() {
        const modal = document.getElementById('modalSelecaoMes');
        const content = document.getElementById('modalSelecaoMesContent');
        
        if (mesesComParcelas.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-calendar-check" style="font-size: 3rem; color: var(--success-color); margin-bottom: 15px;"></i>
                    <h3 style="color: var(--text-dark); margin-bottom: 10px;">Nenhuma parcela pendente</h3>
                    <p style="color: var(--text-light);">Não há meses com parcelas pendentes para pagamento.</p>
                </div>
            `;
        } else {
            let html = `
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text-dark); font-size: 0.95rem;">Selecione o mês que deseja pagar:</p>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            mesesComParcelas.forEach(mes => {
                const isMesAtual = mes.mes === new Date().getMonth() + 1 && mes.ano === new Date().getFullYear();
                const isSelecionado = mesAtualSelecionado && mes.mes === mesAtualSelecionado.mes && mes.ano === mesAtualSelecionado.ano;
                
                html += `
                    <div class="mes-opcao ${isSelecionado ? 'mes-opcao-selecionado' : ''}" 
                         onclick="selecionarMesPagamento(${mes.mes}, ${mes.ano}, ${mes.total})"
                         style="
                            padding: 15px;
                            margin-bottom: 10px;
                            border-radius: 8px;
                            border: 2px solid ${isSelecionado ? 'var(--success-color)' : 'var(--gray-light)'};
                            background: ${isSelecionado ? 'rgba(76, 175, 80, 0.1)' : 'white'};
                            cursor: pointer;
                            transition: all 0.3s;
                         ">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 5px;">
                                    ${formatarMesAno(mes.mes, mes.ano)}
                                    ${isMesAtual ? '<span style="color: var(--accent-color); font-size: 0.8rem; margin-left: 8px;">(ATUAL)</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-light);">
                                    ${mes.compras} compra(s) • ${Object.keys(mes.cartoes).length} cartão(ões)
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;">
                                    ${formatarMoeda(mes.total)}
                                </div>
                                ${isSelecionado ? 
                                    '<div style="font-size: 0.8rem; color: var(--success-color); margin-top: 5px;"><i class="fas fa-check"></i> Selecionado</div>' : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div style="margin-top: 25px; display: flex; gap: 10px;">
                    <button onclick="pagarMesSelecionado()" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-check"></i> Pagar Mês Selecionado
                    </button>
                    <button onclick="fecharModalSelecaoMes()" class="btn btn-warning" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        modal.style.display = 'flex';
    }

    function fecharModalSelecaoMes() {
        document.getElementById('modalSelecaoMes').style.display = 'none';
    }

    function selecionarMesPagamento(mes, ano, total) {
        mesAtualSelecionado = { mes, ano, total };
        
        // Atualizar visualização no modal
        const opcoes = document.querySelectorAll('.mes-opcao');
        opcoes.forEach(opcao => {
            opcao.style.borderColor = 'var(--gray-light)';
            opcao.style.background = 'white';
        });
        
        // Encontrar e destacar a opção selecionada
        opcoes.forEach(opcao => {
            if (opcao.textContent.includes(formatarMesAno(mes, ano))) {
                opcao.style.borderColor = 'var(--success-color)';
                opcao.style.background = 'rgba(76, 175, 80, 0.1)';
            }
        });
    }

    function pagarMesSelecionado() {
        if (mesAtualSelecionado) {
            fecharModalSelecaoMes();
            pagarFaturaMes(mesAtualSelecionado.mes, mesAtualSelecionado.ano);
        }
    }

    // =============================================
    // FUNÇÕES DE ESCRITA (USANDO BACKEND)
    // =============================================

    // Adicionar nova compra (usando backend)
    document.getElementById('adicionarCompra').addEventListener('click', async function() {
        const nome = document.getElementById('nomeProduto').value.trim();
        const local = document.getElementById('localCompra').value.trim();
        const valorString = document.getElementById('valorTotal').value;
        const valor = converterMoedaParaNumero(valorString);
        const data = document.getElementById('dataCompra').value;
        const cartao = document.getElementById('cartao').value;
        const parcelas = parseInt(document.getElementById('parcelas').value);
        const diaFatura = parseInt(document.getElementById('diaFatura').value);
        
        // Validações
        if (!nome) {
            mostrarAlerta('Informe o nome do produto/serviço!', 'error');
            return;
        }
        
        if (!local) {
            mostrarAlerta('Informe o local da compra!', 'error');
            return;
        }
        
        if (!valor || valor <= 0) {
            mostrarAlerta('Informe um valor válido maior que zero!', 'error');
            return;
        }
        
        if (!data) {
            mostrarAlerta('Selecione a data da compra!', 'error');
            return;
        }
        
        if (!cartao) {
            mostrarAlerta('Selecione o cartão usado!', 'error');
            return;
        }
        
        if (!parcelas || parcelas < 1) {
            mostrarAlerta('Selecione o número de parcelas!', 'error');
            return;
        }
        
        // Calcular mês da primeira fatura considerando o dia de vencimento
        const primeiraFatura = calcularMesFatura(data, diaFatura);
        
        const compra = {
            nome_produto: nome,
            local_compra: local,
            valor_total: valor,
            data_compra: data,
            cartao: cartao,
            num_parcelas: parcelas,
            dia_fatura: diaFatura,
            valor_parcela: valor / parcelas,
            status: 'pendente',
            parcelas_pagas: 0,
            valor_em_aberto: valor,
            valor_pago: 0,
            mes_primeira_fatura: primeiraFatura.mes,
            ano_primeira_fatura: primeiraFatura.ano
        };
        
        try {
            const response = await fetch(GASTOS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(compra)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
            
            mostrarAlerta('Compra adicionada com sucesso!', 'success');
            limparFormulario();
            
            // Recarregar dados do Supabase
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao adicionar compra:', error);
            mostrarAlerta(`Erro ao salvar compra: ${error.message}`, 'error');
        }
    });

    // Pagar fatura do mês inteiro
    async function pagarFaturaMes(mes, ano) {
        if (!confirm(`Confirmar pagamento de todas as faturas de ${formatarMesAno(mes, ano)}?`)) return;
        
        try {
            // Buscar todas as compras pendentes
            const { data: compras, error: fetchError } = await supabase
                .from('gastos_mensais')
                .select('*')
                .eq('status', 'pendente');
            
            if (fetchError) {
                throw fetchError;
            }
            
            let totalPago = 0;
            let comprasAtualizadas = [];
            
            // Processar cada compra
            for (const compra of compras) {
                const parcelasPagas = compra.parcelas_pagas || 0;
                const numParcelas = compra.num_parcelas || 1;
                
                if (parcelasPagas >= numParcelas) continue;
                
                // Calcular próxima fatura
                const proximaFatura = calcularProximaFatura(compra);
                
                // Se a próxima fatura é do mês que estamos pagando
                if (proximaFatura && proximaFatura.mes === mes && proximaFatura.ano === ano) {
                    const valorParcela = compra.valor_parcela || (compra.valor_total / numParcelas);
                    
                    // Atualizar no backend
                    const response = await fetch(`${GASTOS_ENDPOINT}/${compra.id}/pagar-parcela`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro ${response.status}: ${errorText}`);
                    }
                    
                    totalPago += valorParcela;
                    comprasAtualizadas.push(compra.id);
                }
            }
            
            if (comprasAtualizadas.length === 0) {
                mostrarAlerta(`Nenhuma fatura encontrada para ${formatarMesAno(mes, ano)}`, 'warning');
                return;
            }
            
            mostrarAlerta(`Todas as faturas de ${formatarMesAno(mes, ano)} pagas com sucesso! Total: ${formatarMoeda(totalPago)}`, 'success');
            
            // Recarregar todos os dados
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao pagar fatura do mês:', error);
            mostrarAlerta(`Erro ao pagar fatura: ${error.message}`, 'error');
        }
    }

    // Limpar formulário
    document.getElementById('limparForm').addEventListener('click', limparFormulario);
    
    function limparFormulario() {
        document.getElementById('nomeProduto').value = '';
        document.getElementById('localCompra').value = '';
        document.getElementById('valorTotal').value = '';
        document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];
        document.getElementById('cartao').value = '';
        document.getElementById('parcelas').value = '1';
        document.getElementById('diaFatura').value = '10';
    }

    // =============================================
    // FUNÇÕES EXISTENTES (MANTIDAS)
    // =============================================

    // Atualizar tabela
    function atualizarTabela(compras) {
        const tbody = document.getElementById('tabelaGastosBody');
        
        if (!compras || compras.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" style="text-align: center; color: var(--text-light); padding: 20px;">
                        Nenhuma compra cadastrada ainda.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = '';
        
        // Ordenar: pendentes primeiro, depois por data
        compras.sort((a, b) => {
            if (a.status === b.status) {
                return new Date(b.data_compra) - new Date(a.data_compra);
            }
            return a.status === 'pendente' ? -1 : 1;
        });
        
        compras.forEach(compra => {
            const status = compra.status === 'pago' ? 'Pago' : 'Pendente';
            const statusClass = compra.status === 'pago' ? 'status-pago' : 'status-pendente';
            
            const valorTotal = garantirNumero(compra.valor_total);
            const numParcelas = garantirNumero(compra.num_parcelas);
            const parcelasPagas = garantirNumero(compra.parcelas_pagas) || 0;
            const valorParcela = garantirNumero(compra.valor_parcela) || (valorTotal / Math.max(1, numParcelas));
            const parcelasRestantes = Math.max(0, numParcelas - parcelasPagas);
            const valorEmAberto = valorParcela * parcelasRestantes;
            const valorPago = valorParcela * parcelasPagas;
            
            const proximaFatura = calcularProximaFatura(compra);
            const proximaFaturaFormatada = proximaFatura ? 
                `${proximaFatura.mes.toString().padStart(2, '0')}/${proximaFatura.ano}` : 
                (compra.status === 'pago' ? 'Pago' : 'N/A');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${compra.nome_produto || 'N/A'}</td>
                <td>${compra.local_compra || 'N/A'}</td>
                <td class="valor-real">${formatarMoeda(valorTotal)}</td>
                <td class="data-formatada">${formatarData(compra.data_compra)}</td>
                <td>${compra.cartao || 'N/A'}</td>
                <td>
                    ${numParcelas}x
                    ${parcelasPagas > 0 ? `<span class="parcela-info">(${parcelasPagas} pagas)</span>` : ''}
                </td>
                <td class="valor-real">${formatarMoeda(valorParcela)}</td>
                <td class="data-formatada">
                    ${proximaFaturaFormatada}
                    ${proximaFatura ? `<span class="parcela-info">${formatarMoeda(proximaFatura.valor)}</span>` : ''}
                </td>
                <td class="valor-real">${formatarMoeda(valorEmAberto)}</td>
                <td class="valor-real">${formatarMoeda(valorPago)}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>
                    <div class="acoes-cell">
                        ${compra.status !== 'pago' ? `
                            <button class="btn-acao btn-pagar" onclick="marcarComoPago(${compra.id})">
                                <i class="fas fa-check"></i> Pagar
                            </button>
                        ` : ''}
                        <button class="btn-acao btn-editar" onclick="editarCompra(${compra.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-acao btn-excluir" onclick="excluirCompra(${compra.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Marcar como pago (usando backend)
    async function marcarComoPago(id) {
        if (!confirm('Marcar esta compra como paga?')) return;
        
        try {
            const response = await fetch(`${GASTOS_ENDPOINT}/${id}/pagar`, {
                method: 'PUT'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
            
            mostrarAlerta('Compra marcada como paga!', 'success');
            
            // Recarregar dados do Supabase
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao marcar como pago:', error);
            mostrarAlerta(`Erro ao marcar como pago: ${error.message}`, 'error');
        }
    }

    // Excluir compra (usando backend)
    async function excluirCompra(id) {
        if (!confirm('Tem certeza que deseja excluir esta compra?')) return;
        
        try {
            const response = await fetch(`${GASTOS_ENDPOINT}/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
            
            mostrarAlerta('Compra excluída com sucesso!', 'success');
            
            // Recarregar todos os dados
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao excluir compra:', error);
            mostrarAlerta(`Erro ao excluir compra: ${error.message}`, 'error');
        }
    }

    // Pagar fatura do cartão (usando backend)
    async function pagarFaturaCartao(cartao, mes, ano) {
        if (!confirm(`Confirmar pagamento da fatura de ${mes}/${ano} do cartão ${cartao}?`)) return;
        
        try {
            // Primeiro, buscar todas as compras pendentes do cartão
            const { data: compras, error: fetchError } = await supabase
                .from('gastos_mensais')
                .select('*')
                .eq('cartao', cartao)
                .eq('status', 'pendente');
            
            if (fetchError) {
                throw fetchError;
            }
            
            let totalPago = 0;
            let comprasAtualizadas = [];
            
            // Processar cada compra
            for (const compra of compras) {
                const parcelasPagas = compra.parcelas_pagas || 0;
                const numParcelas = compra.num_parcelas || 1;
                
                if (parcelasPagas >= numParcelas) continue;
                
                // Calcular próxima fatura
                const proximaFatura = calcularProximaFatura(compra);
                
                // Se a próxima fatura é a que estamos pagando
                if (proximaFatura && proximaFatura.mes === parseInt(mes) && proximaFatura.ano === parseInt(ano)) {
                    const valorParcela = compra.valor_parcela || (compra.valor_total / numParcelas);
                    
                    // Atualizar no backend
                    const response = await fetch(`${GASTOS_ENDPOINT}/${compra.id}/pagar-parcela`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro ${response.status}: ${errorText}`);
                    }
                    
                    totalPago += valorParcela;
                    comprasAtualizadas.push(compra.id);
                }
            }
            
            if (comprasAtualizadas.length === 0) {
                mostrarAlerta(`Nenhuma fatura encontrada para ${cartao} em ${mes}/${ano}`, 'warning');
                return;
            }
            
            mostrarAlerta(`Fatura de ${mes}/${ano} do cartão ${cartao} paga com sucesso! Total: ${formatarMoeda(totalPago)}`, 'success');
            
            // Recarregar dados do Supabase
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao pagar fatura do cartão:', error);
            mostrarAlerta(`Erro ao pagar fatura: ${error.message}`, 'error');
        }
    }

    // Atualizar faturas pendentes
    function atualizarFaturasPendentes(faturas) {
        const container = document.getElementById('faturasContainer');
        container.innerHTML = '';
        
        const hoje = new Date();
        const mesAtual = hoje.getMonth() + 1;
        const anoAtual = hoje.getFullYear();
        
        faturas.forEach(fatura => {
            const isMesAtual = fatura.mes === mesAtual && fatura.ano === anoAtual;
            const mesAnoFormatado = formatarMesAno(fatura.mes, fatura.ano);
            
            const card = document.createElement('div');
            card.className = 'fatura-card';
            if (isMesAtual) {
                card.style.borderLeftColor = 'var(--error-color)';
            }
            
            card.innerHTML = `
                <div class="fatura-header">
                    <div class="fatura-titulo">
                        <i class="fas fa-credit-card"></i>
                        ${fatura.cartao}
                        ${isMesAtual ? '<span style="color: var(--error-color); font-size: 0.8rem; margin-left: 5px;">(MÊS ATUAL)</span>' : ''}
                    </div>
                    <div class="fatura-valor">${formatarMoeda(fatura.valor_total)}</div>
                </div>
                <div class="fatura-detalhes">
                    <div class="fatura-item">
                        <span>Mês:</span>
                        <span><strong>${mesAnoFormatado}</strong></span>
                    </div>
                    <div class="fatura-item">
                        <span>Compras:</span>
                        <span>${fatura.compras.length} item(s)</span>
                    </div>
                    ${fatura.compras.slice(0, 3).map(compra => `
                        <div class="fatura-item" style="font-size: 0.85rem;">
                            <span>${compra.nome_produto || 'Sem nome'}</span>
                            <span>${formatarMoeda(compra.valor_parcela)}</span>
                        </div>
                    `).join('')}
                    ${fatura.compras.length > 3 ? `
                        <div class="fatura-item" style="font-size: 0.8rem; color: var(--text-light);">
                            <span>+ ${fatura.compras.length - 3} mais...</span>
                        </div>
                    ` : ''}
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="pagarFaturaCartao('${fatura.cartao}', ${fatura.mes}, ${fatura.ano})" 
                            class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-check"></i> Pagar Fatura (${formatarMoeda(fatura.valor_total)})
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // Atualizar resumo cartões
    function atualizarResumoCartoes(resumo, comprasPorCartao) {
        const container = document.getElementById('cartoesContainer');
        
        if (!resumo || typeof resumo !== 'object') {
            container.innerHTML = `
                <div class="cartao-card" style="grid-column: 1 / -1;">
                    <div class="cartao-header">
                        <div class="cartao-nome">
                            <i class="fas fa-exclamation-triangle"></i>
                            Dados inválidos
                        </div>
                    </div>
                    <div class="cartao-detalhes">
                        <p>Os dados do resumo estão em formato inválido.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        todosCartoes.forEach(cartao => {
            const dados = resumo[cartao] || {
                total: 0,
                compras: 0,
                parcelas_pendentes: 0,
                valor_pendente: 0,
                valor_pago: 0,
                valor_aberto: 0,
                parcelas_pagas_total: 0,
                parcelas_total: 0
            };
            
            const total = garantirNumero(dados.total);
            const compras = garantirNumero(dados.compras);
            const parcelasPendentes = garantirNumero(dados.parcelas_pendentes);
            const valorPendente = garantirNumero(dados.valor_pendente);
            const valorAberto = garantirNumero(dados.valor_aberto) || valorPendente;
            const valorPago = garantirNumero(dados.valor_pago) || Math.max(0, total - valorAberto);
            const parcelasPagasTotal = garantirNumero(dados.parcelas_pagas_total);
            const parcelasTotal = garantirNumero(dados.parcelas_total);
            
            if (compras > 0 || total > 0) {
                const comprasCartao = comprasPorCartao[cartao] || [];
                
                const card = document.createElement('div');
                card.className = 'cartao-card';
                card.innerHTML = `
                    <div class="cartao-header" onclick="toggleCartaoDetalhes(this)">
                        <div class="cartao-nome">
                            <i class="fas fa-credit-card"></i>
                            ${cartao}
                            <button class="cartao-expand-btn">
                                <i class="fas fa-chevron-down"></i>
                                Detalhes
                            </button>
                        </div>
                        <div class="cartao-total">${formatarMoeda(total)}</div>
                    </div>
                    <div class="cartao-detalhes">
                        <div class="cartao-detalhes-item">
                            <span>Total de Compras:</span>
                            <span><strong>${compras}</strong></span>
                        </div>
                        <div class="cartao-detalhes-item">
                            <span>Parcelas:</span>
                            <span><strong>${parcelasPagasTotal}/${parcelasTotal}</strong></span>
                        </div>
                        <div class="cartao-detalhes-item">
                            <span>Parcelas Pendentes:</span>
                            <span><strong>${parcelasPendentes}</strong></span>
                        </div>
                    </div>
                    <div class="cartao-resumo">
                        <div class="resumo-item">
                            <span class="resumo-titulo">Valor Pago:</span>
                            <span class="resumo-valor resumo-pago">${formatarMoeda(valorPago)}</span>
                        </div>
                        <div class="resumo-item">
                            <span class="resumo-titulo">Valor em Aberto:</span>
                            <span class="resumo-valor resumo-aberto">${formatarMoeda(valorAberto)}</span>
                        </div>
                        <div class="resumo-item">
                            <span class="resumo-titulo">Total Gasto:</span>
                            <span class="resumo-valor resumo-total">${formatarMoeda(total)}</span>
                        </div>
                    </div>
                    <div class="cartao-detalhes-expansivel">
                        <div class="compras-lista">
                            <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                                <i class="fas fa-shopping-cart"></i> Compras deste Cartão
                            </h4>
                            ${comprasCartao.length === 0 ? 
                                '<p style="text-align: center; color: var(--text-light); padding: 20px;">Nenhuma compra encontrada</p>' : 
                                comprasCartao.map(compra => criarItemCompraResumo(compra)).join('')
                            }
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        });
        
        if (container.innerHTML === '') {
            container.innerHTML = `
                <div class="cartao-card" style="grid-column: 1 / -1;">
                    <div class="cartao-header">
                        <div class="cartao-nome">
                            <i class="fas fa-info-circle"></i>
                            Nenhuma compra registrada
                        </div>
                    </div>
                    <div class="cartao-detalhes">
                        <p>Nenhuma compra foi registrada nos cartões ainda.</p>
                        <p>Adicione compras usando o formulário acima.</p>
                    </div>
                </div>
            `;
        }
    }

    // Função para criar o HTML de um item de compra no resumo
    function criarItemCompraResumo(compra) {
        const valorTotal = garantirNumero(compra.valor_total);
        const numParcelas = garantirNumero(compra.num_parcelas);
        const parcelasPagas = garantirNumero(compra.parcelas_pagas) || 0;
        const valorParcela = garantirNumero(compra.valor_parcela) || (valorTotal / Math.max(1, numParcelas));
        const parcelasRestantes = Math.max(0, numParcelas - parcelasPagas);
        const valorEmAberto = valorParcela * parcelasRestantes;
        const valorPago = valorParcela * parcelasPagas;
        
        return `
            <div class="compra-item">
                <div class="compra-info">
                    <div class="compra-nome">${compra.nome_produto || 'Sem nome'}</div>
                    <div class="compra-detalhes">
                        <span><i class="fas fa-calendar"></i> ${formatarData(compra.data_compra)}</span>
                        <span><i class="fas fa-store"></i> ${compra.local_compra || 'Sem local'}</span>
                        <span class="parcela-status ${parcelasRestantes === 0 ? 'parcela-paga' : 'parcela-pendente'}">
                            ${parcelasPagas}/${numParcelas} parcelas
                        </span>
                    </div>
                </div>
                <div class="compra-valor">
                    <div>Total: ${formatarMoeda(valorTotal)}</div>
                    <div style="font-size: 0.8rem; color: var(--text-light);">
                        Parcela: ${formatarMoeda(valorParcela)}
                    </div>
                </div>
                <div class="compra-acoes">
                    <button class="btn-acao btn-editar" onclick="abrirModalEditar(${compra.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-acao btn-excluir" onclick="excluirCompra(${compra.id})" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // Função para expandir/recolher detalhes do cartão
    function toggleCartaoDetalhes(element) {
        const card = element.closest('.cartao-card');
        card.classList.toggle('expanded');
        
        const icon = element.querySelector('.fa-chevron-down');
        if (card.classList.contains('expanded')) {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }

    // =============================================
    // FUNÇÕES DE EDIÇÃO DE COMPRAS
    // =============================================

    // Função para abrir modal de edição
    async function abrirModalEditar(id) {
        try {
            // Buscar dados da compra
            const { data: compra, error } = await supabase
                .from('gastos_mensais')
                .select('*')
                .eq('id', id)
                .single();
            
            if (error) {
                throw error;
            }
            
            // Formatando o valor para exibição no input
            const valorFormatado = formatarNumeroParaInput(compra.valor_total);
            
            // Preencher o modal com os dados da compra
            const modalContent = document.getElementById('modalEditarContent');
            modalContent.innerHTML = `
                <form id="formEditarCompra">
                    <div class="grid-3">
                        <div class="form-group">
                            <label for="editarNomeProduto">
                                <i class="fas fa-tag"></i>
                                Produto/Serviço
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-pen input-icon"></i>
                                <input type="text" id="editarNomeProduto" value="${compra.nome_produto || ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarLocalCompra">
                                <i class="fas fa-store"></i>
                                Local
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-map-marker-alt input-icon"></i>
                                <input type="text" id="editarLocalCompra" value="${compra.local_compra || ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarValorTotal">
                                <i class="fas fa-dollar-sign"></i>
                                Valor Total (R$)
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-money-bill-wave input-icon"></i>
                                <input type="text" id="editarValorTotal" value="${valorFormatado}" class="money-input" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-4">
                        <div class="form-group">
                            <label for="editarDataCompra">
                                <i class="fas fa-calendar"></i>
                                Data da Compra
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-calendar input-icon"></i>
                                <input type="date" id="editarDataCompra" value="${compra.data_compra ? compra.data_compra.split('T')[0] : ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarCartao">
                                <i class="fas fa-credit-card"></i>
                                Cartão
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-credit-card input-icon"></i>
                                <select id="editarCartao" required>
                                    ${todosCartoes.map(cartao => 
                                        `<option value="${cartao}" ${compra.cartao === cartao ? 'selected' : ''}>${cartao}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarParcelas">
                                <i class="fas fa-calendar-alt"></i>
                                Parcelas
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-sort-numeric-up input-icon"></i>
                                <select id="editarParcelas" required>
                                    ${Array.from({length: 12}, (_, i) => i + 1).map(num => 
                                        `<option value="${num}" ${compra.num_parcelas === num ? 'selected' : ''}>${num}x</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarDiaFatura">
                                <i class="fas fa-calendar-check"></i>
                                Dia da Fatura
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-calendar-check input-icon"></i>
                                <input type="number" id="editarDiaFatura" value="${compra.dia_fatura || 10}" min="1" max="31" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="editarParcelasPagas">
                                <i class="fas fa-calendar-check"></i>
                                Parcelas Pagas
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-calendar-check input-icon"></i>
                                <input type="number" id="editarParcelasPagas" value="${compra.parcelas_pagas || 0}" min="0" max="${compra.num_parcelas || 1}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarStatus">
                                <i class="fas fa-check-circle"></i>
                                Status
                            </label>
                            <div class="input-with-icon">
                                <i class="fas fa-check-circle input-icon"></i>
                                <select id="editarStatus">
                                    <option value="pendente" ${compra.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="pago" ${compra.status === 'pago' ? 'selected' : ''}>Pago</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="buttons" style="margin-top: 20px;">
                        <button type="button" onclick="salvarEdicaoCompra(${compra.id})" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Salvar Alterações
                        </button>
                        <button type="button" onclick="fecharModalEditar()" class="btn btn-warning">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            // Aplicar máscara de moeda ao campo de edição
            const editarValorTotalInput = document.getElementById('editarValorTotal');
            if (editarValorTotalInput) {
                aplicarMascaraMoeda(editarValorTotalInput);
            }
            
            // Mostrar o modal
            document.getElementById('modalEditarCompra').style.display = 'flex';
            
        } catch (error) {
            console.error('Erro ao abrir modal de edição:', error);
            mostrarAlerta('Erro ao carregar dados da compra para edição.', 'error');
        }
    }

    // Função para fechar modal de edição
    function fecharModalEditar() {
        document.getElementById('modalEditarCompra').style.display = 'none';
    }

    // Função para fechar modal de pagar
    function fecharModalPagar() {
        document.getElementById('modalPagarFatura').style.display = 'none';
    }

    // Função para salvar edição da compra
    async function salvarEdicaoCompra(id) {
        const nome = document.getElementById('editarNomeProduto').value.trim();
        const local = document.getElementById('editarLocalCompra').value.trim();
        const valorString = document.getElementById('editarValorTotal').value;
        const valor = converterMoedaParaNumero(valorString);
        const data = document.getElementById('editarDataCompra').value;
        const cartao = document.getElementById('editarCartao').value;
        const parcelas = parseInt(document.getElementById('editarParcelas').value);
        const diaFatura = parseInt(document.getElementById('editarDiaFatura').value);
        const parcelasPagas = parseInt(document.getElementById('editarParcelasPagas').value);
        const status = document.getElementById('editarStatus').value;
        
        // Validações
        if (!nome || !local || !valor || valor <= 0 || !data || !cartao || !parcelas || parcelas < 1) {
            mostrarAlerta('Preencha todos os campos corretamente!', 'error');
            return;
        }
        
        if (parcelasPagas < 0 || parcelasPagas > parcelas) {
            mostrarAlerta('Número de parcelas pagas inválido!', 'error');
            return;
        }
        
        const valorParcela = valor / parcelas;
        const parcelasRestantes = Math.max(0, parcelas - parcelasPagas);
        const valorEmAberto = valorParcela * parcelasRestantes;
        const valorPago = valorParcela * parcelasPagas;
        
        try {
            const response = await fetch(`${GASTOS_ENDPOINT}/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome_produto: nome,
                    local_compra: local,
                    valor_total: valor,
                    data_compra: data,
                    cartao: cartao,
                    num_parcelas: parcelas,
                    dia_fatura: diaFatura,
                    parcelas_pagas: parcelasPagas,
                    valor_parcela: valorParcela,
                    valor_em_aberto: valorEmAberto,
                    valor_pago: valorPago,
                    status: status
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
            
            mostrarAlerta('Compra atualizada com sucesso!', 'success');
            fecharModalEditar();
            
            // Recarregar todos os dados
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            
        } catch (error) {
            console.error('Erro ao salvar edição:', error);
            mostrarAlerta(`Erro ao atualizar compra: ${error.message}`, 'error');
        }
    }

    // =============================================
    // INICIALIZAÇÃO
    // =============================================

    document.addEventListener('DOMContentLoaded', async function() {
        // Carregar dados do Supabase
        try {
            await carregarGastosDoSupabase();
            await carregarResumoCartoesDoSupabase();
            await carregarFaturasPendentesDoSupabase();
            await carregarDashboard();
            await carregarParcelasPorMes();
            console.log('✅ Dados carregados do Supabase');
        } catch (error) {
            console.error('❌ Erro ao carregar dados do Supabase:', error);
            mostrarAlerta('Não foi possível carregar os dados do servidor.', 'error');
        }
    });
    
    // Função para editar compra
    async function editarCompra(id) {
        await abrirModalEditar(id);
    }
    </script>
</body>
</html>